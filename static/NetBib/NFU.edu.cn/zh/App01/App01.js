importScripts("https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js");
//importScripts("https://cdn.jsdelivr.net/pyodide/v0.27.5/pyc/pyodide.js");

function sendPatch(patch, buffers, msg_id) {
  self.postMessage({
    type: 'patch',
    patch: patch,
    buffers: buffers
  })
}

async function startApplication() {
  console.log("Loading pyodide!");
  self.postMessage({type: 'status', msg: 'Loading pyodide'})
  self.pyodide = await loadPyodide();
  self.pyodide.globals.set("sendPatch", sendPatch);
  console.log("Loaded!");
  await self.pyodide.loadPackage("micropip");
  await self.pyodide.loadPackage("matplotlib");
  const env_spec = ['https://cdn.holoviz.org/panel/wheels/bokeh-3.7.3-py3-none-any.whl', 'https://cdn.holoviz.org/panel/1.7.1/dist/wheels/panel-1.7.1-py3-none-any.whl', 'pyodide-http==0.2.1', 'holoviews', 'hvplot', 'numpy', 'pandas', 'param', 'pyecharts', 'requests', 'yaml']
  for (const pkg of env_spec) {
    let pkg_name;
    if (pkg.endsWith('.whl')) {
      pkg_name = pkg.split('/').slice(-1)[0].split('-')[0]
    } else {
      pkg_name = pkg
    }
    self.postMessage({type: 'status', msg: `Installing ${pkg_name}`})
    try {
      await self.pyodide.runPythonAsync(`
        import micropip
        await micropip.install('${pkg}');
      `);
    } catch(e) {
      console.log(e)
      self.postMessage({
	type: 'status',
	msg: `Error while installing ${pkg_name}`
      });
    }
  }
  console.log("Packages loaded!");
  self.postMessage({type: 'status', msg: 'Executing code'})
  const code = `
  \nimport asyncio\n\nfrom panel.io.pyodide import init_doc, write_doc\n\ninit_doc()\n\nthis_org01 = 'Nanfang Coll Guangzhou'\nlocale   = 'zh_Hans'\n_this_app_, _this_version_ = 'App01', '0.2.0'   # Which GUI_translation to use mainlyl\n_this_app_N_ = int(_this_app_[-2:])\ndebug=False\nfrom urllib.parse import urljoin\ninit_URL={'url_specs': {'base_url': '.', 'favicon': 'https://oxfordroadmap.github.io/vis/favicon.ico', 'logo': 'https://oxfordroadmap.github.io/vis/icon.svg', 'site_url': 'https://oxfordroadmap.github.io/vis/zh/index'}, 'url_data': {'data_tsv': 'https://oxfordroadmap.github.io/vis/NFU.edu.cn/assets/tb/App.tsv', 'locale_yml': 'https://oxfordroadmap.github.io/vis/NFU.edu.cn/assets/locale/Dt.yml'}}\n\n\nurls_remote = {k:  {'url':v, 'ext':f".{k.split('_')[1]}"} for k,v in init_URL['url_data'].items()}\n\nimport requests\nimport io\nimport pandas as pd\nimport yaml \n\nobjects = dict()\nfor stem, obj in urls_remote.items():\n    url, ext = obj['url'], obj['ext']\n    response = requests.get(url)\n    response.encoding = 'utf8'\n    if response.status_code == 200: \n        d = response.text\n        match ext:\n            case '.tsv':\n                df = pd.read_csv (io.StringIO(d), index_col=0, sep='\\t')\n                objects[stem] = df\n            case '.yml':\n                dt = yaml.safe_load(io.StringIO(d))\n                objects[stem] = dt           \n    else:\n        print(f"Failed to download file {url} {ext}. Status code: {response.status_code}")\n\ndf     = objects['data_tsv']\nDtrans = objects['locale_yml']   ##### \U0001f5e3 translation yaml datasets\n\n\nDtrans_content = { k:v for k, v in Dtrans.items() if k != '_meta_' and 'GUI' not in k}   ## columns_translation\nDtrans_meta = Dtrans['_meta_']                                        ## DataFrame meta and others\nDtrans_GUI  = Dtrans[f"GUI_{_this_app_}"] |  Dtrans[f"GUI_url_misc"]                                       ## GUI\n\nDtr_m = Dtrans_GUI | Dtrans_meta\ntr_m = {k:v[locale] for k,v in Dtr_m.items()}\n\nimport gettext ### Now Deferred translations \ndef N_(message, tr_d=tr_m): # def _(message): \n    if locale in ['zh_Hans', 'en']:\n        return tr_d.get(message, message)\n    elif locale == 'None':\n        return message\n\n\n\nimport numpy as np\nclass DataFrameLocale (pd.DataFrame) :  # inherit from pd.DataFrame\n    _metadata = ["df", "df_out", "locale", "d_col_trans", "d_content_trans"]        # Allows safe storage of extra attributes\n    def __init__(self, data, d_col_trans=None, d_content_trans=None, *args, **kwargs):\n        super().__init__(*args, **kwargs)                       # Pass all args & kwargs to pandas.DataFrame\n        \n        """Initialize the TranslatableDataFrame.\n        Args:\n        - data (list of dict): Raw data for DataFrame.\n        - d_col_trans (dict): Column name translations.\n        - d_content_trans (dict): Cell content translations.\n        Attributes:\n        - df:      original dataframe df\n        - df_out:  translated dataframe df\n        - locale:  locale for current df_out\n        """\n        self.df = self._constructor (data)\n        self.locale = None                                         # default\n        self.d_col_trans     = d_col_trans                         # This avoids the warning\n        self.d_content_trans = d_content_trans                     # This avoids the warning\n    \n    def set_locale (self, locale=None):\n        """Switch to a given locale, thereby changing df_out."""\n        if locale is None:\n            self.locale = None\n            self.df_out = self.df             # Reset\n        else:\n            self.locale = locale\n            self.get_df(locale)\n        \n    def get_df (self, locale=None):\n        """Return the modified or the original DataFrame."""\n        if locale is None:\n            self.locale = None\n            return self.df                                         # Return the original DataFrame\n            \n        else:\n            self.locale = locale\n            self.df_out = self.df.copy()\n            if self.d_content_trans is not None:                   # First translate content\n                self.translate_content(locale) \n            if self.d_col_trans is not None:                       # Then translate columns\n                _df_ = self.df_out.copy()\n                self.df_out = self.translate_columns(_df_, locale)                \n            return self.df_out\n \n    def translate_content(self, locale):\n        """Translate cell content to the specified language."""\n        for col in list(self.d_content_trans.keys()):\n            if col in self.df.columns:\n                self.df_out.loc[:,col] = self.df[col].map(lambda x: self.d_content_trans[col].get(x, {}).get(locale, x))\n\n    def translate_columns(self, _df_, locale):\n        """Translate column names to the specified language."""\n        columns_rename_dict = {col: self.d_col_trans.get(col, {}).get(locale, col) for col in self.df.columns}\n        return _df_.rename(columns=columns_rename_dict)\n\n\n\n\ncontent_translations = {f"t_{k}":v for k,v in Dtrans_content.items()}\ncontent_translations['Dtype_detail'] = content_translations['t_Dtype_detail']\ndfl = DataFrameLocale (df, d_content_trans = content_translations, d_col_trans=Dtrans_meta) #, d_col_trans=columns_translations)#, d_content_trans = content_translations)\ndfl.set_locale (locale) \n\n_q1_ = f"{N_('t_org01')}=='{N_('this_org01')}' and {N_('year')}>=2012" \ndf = dfl.df_out.query(_q1_) # The dataset contains only the main org01\ndf.shape, dfl.df_out.shape\n\n\n\ndef get_top_sorted (df, col, topN=25):\n    return df.groupby(col).agg({N_('weight'):"sum"}).sort_values(by=N_('weight'), ascending=False).head(topN)\n    \ndef get_opts_default (_df_, col, topN=15, debug=True):\n    if col == N_('year'):                                 ### Selector year (int) + (range)\n            _opts_ = list( _df_[col].unique().tolist() )   # .tolist() avoid extra downcasting \n            _opts_default_ = max(_opts_)-3\n    elif col==N_('t_org01'):                              ### Selector t_org02 (dict)\n            _opts_ = list( get_top_sorted(_df_, col, topN= topN).index.tolist())\n            _opts_ = {"All": None} | dict(zip(_opts_,_opts_))\n            _opts_default_ = N_('this_org01')\n    elif col==N_('t_org02'):                              ### Selector t_org02 (dict)\n        _opts_ = list( get_top_sorted(_df_, col, topN= topN).index.tolist())\n        _opts_ ={N_('All'): None} |  dict(zip(_opts_,_opts_))        ### {"All": None} |\n        _opts_default_ = None\n    elif col==N_('Dtype_detail'):                                \n        _opts_ = sorted ( list( _df_[col].unique().tolist() )   )\n        _opts_default_ = _opts_                  ### List selector: default all chosen\n    elif col==N_('method'):                                \n        _opts_ = list( _df_[col].unique().tolist() )   \n        _opts_default_ = N_('UTD_fc')\n    elif col==N_('db'):                                   ### Selector db (list)\n        _opts_ = list( _df_[col].unique() )\n        _opts_ = {"EI|WoS": None } | dict(zip(_opts_,_opts_))\n        _opts_default_ = None # "EI|WoS"\n    \n    if debug:\n        print (_opts_, _opts_default_)\n    return dict(zip(['opts','default'],[_opts_, _opts_default_]))\n\ndef construct_objects_for_UI_from_datasets (_df_in_, _df_in_2, debug = True):\n    _objects_ = dict()\n    for col in [N_('t_org01')]:\n        _objects_[col] = get_opts_default (_df_in_, col, debug=debug)\n    for col in [N_('year'), N_('db'), N_('method'), N_('t_org02'), N_('Dtype_detail')]:\n        if debug: print (f">>> {col}", end="")\n        try:\n            _objects_[col] = get_opts_default (_df_in_2, col, debug=False)\n        except Exception as e:\n            if debug: print (e, end="!")\n        if debug: print ("---")\n    \n    if debug: print ([c for c in _objects_ if c in [N_('year')]])\n    for col in [c for c in _objects_ if c in [N_('year')]]:\n        vmax, vmin = max(_objects_[col]['opts']), min(_objects_[col]['opts'])\n        _objects_[f"range_{col}"] = dict(zip(['opts','default'],[(vmin, vmax), (vmax-10, vmax)]))#   for App02 (vmax-5, vmax-1)\n\n    if debug: print (_q1_, _df_in_.shape[1],_df_in_2.shape[1])\n    if debug: print ( _objects_.keys() )\n    return _objects_\n\n\n\n_objects_ = construct_objects_for_UI_from_datasets (dfl.df_out, dfl.df_out, debug=False)  \n_objects_.keys()\nprint ( _objects_[N_('col_range_year')] )\n\n\nDt_org02  = {k:v[locale] for k,v in Dtrans['org02'].items()}\nlist_org02_default_unmute = ['sch elect & comp engn','business sch','accounting sch','higher educ impact assessment ctr','finance & accounting res ctr']\nmuted_false_default = [N_(x, tr_d=Dt_org02) for x in list_org02_default_unmute]  # Reference Point to be Interactive! \nmuted_false_default\n\n\n\nimport param\nimport panel as pn\n\npn.extension(design='native', global_css=['.bk-header {--pn-tab-padding-x: 0.5rem;}', ':root { --pn-tab-padding-x: 0.5rem; --type-ramp-base-font-size: 13px; }'])  # ;  /* Set your desired base font size */\npn.extension('tabulator')    # tabulator\npn.extension('katex')          # markdown and LaTeX c.f. #pn.extension('mathjax')   \npn.config.throttled = True   # faster response for sliders\npn.extension(defer_load=True, loading_indicator=True) # better UX with loading indicator.. see [bound functions for better UX](https://panel.holoviz.org/how_to/best_practices/user_experience.html)\n\nDarkTheme    = pn.theme.base.DarkTheme\nDefaultTheme = pn.theme.base.DefaultTheme\n\npn.config.global_css\n\ndebug=True\n\nif _this_app_N_ ==0:\n    DashboardTitle = N_(f'DashboardTitle{_this_app_N_:02d}') .format(N_('this_org01'))    #       <===================== this_org01 required\nelse:\n    DashboardTitle = N_('this_org01')+N_('DashboardTitleShort')+N_(f'DashboardTitle{_this_app_N_:02d}') \n\n    \ntemplate_param= dict(\n    base_url =init_URL['url_specs']['base_url'],   #   <===================== this_org01 required\n    site_url =init_URL['url_specs']['site_url'],\n    logo =    init_URL['url_specs']['logo'],\n    favicon = init_URL['url_specs']['favicon'],\n    title = DashboardTitle,\n    main_max_width= "1280px",\n    row_height = 100,\n    theme_toggle= True,\n    sidebar_width = 380,\n    sidebar_footer = f"""<fast-breadcrumb><fast-breadcrumb-item href="https://oxon8.netlify.app">\xa9 2025 Oxford Roadmapping </fast-breadcrumb-item><fast-breadcrumb-item href="https://creativecommons.org/licenses/by-nc-nd/4.0">CC BY NC ND 4.0</fast-breadcrumb-item>\n    <fast-breadcrumb-item href="{N_('url_visNetZero')}">visNetZero</fast-breadcrumb-item><fast-breadcrumb-item href="{N_('url_visCEADs')}">visCEADs</fast-breadcrumb-item></fast-breadcrumb>""",\n    header_color="#002147",      # Oxford blue color https://www.colorxs.com/palette/hex/002147-a3ced9-dae5f2\n    header_background="#e2effe", # https://icolorpalette.com/color/oxford-blue\n    accent_base_color="#0066dc", # https://panel.holoviz.org/reference/templates/FastGridTemplate.html\n    header_neutral_color = "#3f98ff",\n    meta_description = DashboardTitle + " by Oxford Roadmapping",\n    meta_keywords = "Bibliometrics; Ranking; Nangfang College Guangzhou; academic performance; impact factor; impact assessment; impact evaluation; \u6587\u732e\u8ba1\u91cf\u5b66\uff1b\u6392\u540d\uff1b\u5e7f\u5dde\u5357\u65b9\u5b66\u9662\uff1b\u5b66\u672f\u8868\u73b0\uff1b\u5f71\u54cd\u56e0\u5b50\uff1b\u5f71\u54cd\u8bc4\u4f30\uff1b\u5f71\u54cd\u8bc4\u4ef7",\n    meta_author = "Han-Teng Liao \u5ed6\u6c49\u817e \u5ed6\u6f22\u9a30 ",\n)\n\nif "zh" in locale: template_param['font_url'] = 'https://fonts.font.im/css?family=Open+Sans' \n\n\n\ncss = """\n.alert {\n  margin: 0;\n  padding: 0.75rem 0.5rem;\n  width: calc(100%) !important;\n}\n.bk-tab {\n  padding: 0.5em 0.5em;\n  font-size: 1.25em;\n}\n.bk-tab.bk-active {\n  padding: 0.5em 0.5em;\n  font-size: 1.6em;\n  color: var(--accent-foreground-focus);\n  background-color: var(--active-bg);\n  border-color: var(--primary-bg-color);\n  text-shadow: 1px 1px 12px #fff, -1px -1px 12px #fff, 1px 5px 5px #fff, 1px -5px 5px #fff;\n}\n.card-header {\n  border-radius: calc(var(--border-radius) * 3) !important;\n}\n.card {\n  border-radius: calc(var(--border-radius) * 3)  !important;\n  border: 1px solid var(--warning-bg-color);\n  box-shadow: 5px 8px 8px var(--panel-shadow-color);\n  margin-bottom: 1.25em;\n}\n.alert{\n  width: width: calc(100%);\n  font-size: 1.25em;\n  line-height: 120%;\n  border: 1px solid transparent;\n  border-radius: var(--border-radius);\n}\nfast-card {\n    padding: 0.5em 0.5em !important;\n}\n"""\npn.extension(raw_css=[css])\n\n\nstylesheet = f"""\n:host(.alert) {{\n  color: {pn.template.FastGridTemplate.accent_base_color};\n}}\n"""\nprint (stylesheet)\n\npn_card_custom_style = {\n    'border': '1px solid var(--warning-bg-color)',\n}\n\npn_card_custom_style ['border'] = '1px solid var(--info-bg-color)'\npn_card_custom_style_i = pn_card_custom_style.copy()\npn_card_custom_style ['border'] = '1px solid var(--warning-bg-color)'\npn_card_custom_style_w = pn_card_custom_style.copy()\npn_card_custom_style ['border'] = '1px solid var(--danger-bg-color)'\npn_card_custom_style_d = pn_card_custom_style.copy() \npn_card_custom_style ['border'] = '1px solid var(--secondary-bg-color)'\npn_card_custom_style_s = pn_card_custom_style.copy() \n\n\napp_icon_html = """<svg class="icon_app" x="0px" y="0px" width="24px" viewBox="-25 0 150 100" style="enable-background:new 0 0 122.88 98.53" xml:space="preserve"><style type="text/css">.st0{{fill-rule:evenodd;clip-rule:evenodd;}}</style><g><path class="st0" d="M7.55,16.44L7.2,39.99v49.32c0,0.58,0.23,1.09,0.61,1.48c0.39,0.39,0.9,0.61,1.48,0.61h86.12 c0.58,0,1.09-0.23,1.48-0.61c0.39-0.39,0.61-0.9,0.61-1.48l6.89,0.01v1.65c0,4.16-3.4,7.55-7.55,7.55H7.55 C3.4,98.53,0,95.13,0,90.97V23.99C0,19.84,3.4,16.44,7.55,16.44L7.55,16.44z M26.04,0h89.29c4.16,0,7.55,3.4,7.55,7.55v66.98 c0,4.15-3.4,7.55-7.55,7.55H26.04c-4.15,0-7.55-3.4-7.55-7.55V7.55C18.48,3.4,21.88,0,26.04,0L26.04,0z M116.02,23.55H25.68v49.32 c0,0.58,0.23,1.09,0.61,1.48c0.39,0.39,0.9,0.61,1.48,0.61h86.12c0.58,0,1.09-0.23,1.48-0.61c0.39-0.39,0.61-0.9,0.61-1.48V23.55 H116.02L116.02,23.55z M108.14,8.49c2.06,0,3.73,1.67,3.73,3.73c0,2.06-1.67,3.73-3.73,3.73c-2.06,0-3.73-1.67-3.73-3.73 C104.4,10.16,106.07,8.49,108.14,8.49L108.14,8.49z M82.85,8.49c2.06,0,3.73,1.67,3.73,3.73c0,2.06-1.67,3.73-3.73,3.73 c-2.06,0-3.73-1.67-3.73-3.73C79.11,10.16,80.78,8.49,82.85,8.49L82.85,8.49z M95.49,8.49c2.06,0,3.73,1.67,3.73,3.73 c0,2.06-1.67,3.73-3.73,3.73c-2.06,0-3.73-1.67-3.73-3.73C91.76,10.16,93.43,8.49,95.49,8.49L95.49,8.49z"></path></g></svg>"""\nnav_button = '<a href="{href}" style="padding: 8px 0px; line-height: 250%; border: 2px solid var(--primary-text-color); border-radius: 5px;" target="_blank">'+app_icon_html+'{text} </a>'\nnav_button_here = '<span style="padding: 8px 0px; line-height: 250%; border: 2px solid var(--neutral-foreground-hint); border-radius: 5px;" target="_blank"> {text} </span>'\nnav_button_href  = "../App{k:02d}/App{k:02d}.html" ## nav_button_href  = "./App{k:02d}.html"\n\ndefine_tabs = { i:f'DashboardTitle{i:02}' for i in range(5)}\ndefine_tabs_title = { k:N_(v).format(N_('this_org01')) for k,v in define_tabs.items()}\nprint (define_tabs_title)\ndefine_tabs_title_short = { k: v[0:1]+ v.split(' -- ')[1].split(' ')[0] for k,v in define_tabs_title.items()}  #  k:"\U0001f3db" if k==0  # #k:v.split(' -- ')[1].split(' ')[0]                        else \ndefine_tabs_title_short = { k:v if k not in [1,3,4] else v[0:2] for k,v in define_tabs_title_short.items()}\ndefine_tabs_title_short = { k:v if k not in [0] else v[0:1]+"\ua7f7" for k,v in define_tabs_title_short.items()}\nprint (define_tabs_title_short)\nd_GUI_App_label = {int(k.replace('GUI_App','')):k for k in Dtrans.keys() if 'GUI_App' in k }\nd_GUI_App_trans = {int(k.replace('GUI_App','')):Dtrans[k] for k in Dtrans.keys() if 'GUI_App' in k }\n\n\nl_type_Alert = ['warning', 'danger', 'success', 'primary', 'info']\nl_pn_cards = []\nl_pn_cards_simple = []\n\ndef construct_pane_Alert ( text, alert_type):\n    return pn.pane.Alert ( text, alert_type=alert_type, sizing_mode='stretch_width', stylesheets=[stylesheet], align='center')  \n    \nfor k, dt in d_GUI_App_trans.items():\n    tr_m = tr_m | {k: v[locale] for k,v in dt.items()}  ##### Using particular dictionary for updating\n    AlertHighlightTitle = N_('AlertHighlightTitle', tr_d=tr_m).format(N_('this_org01'))\n    text_Alert_this =  ( \n        f"{N_('AlertHighlight', tr_d=tr_m)} \\n"\n        f"{N_('AlertBulletPoints', tr_d=tr_m)}\\n"\n    )\n    if k == _this_app_N_:\n        text_Alert_this =  nav_button_here.format(text=f'App{k:02d}') + text_Alert_this \n    else:\n        text_Alert_this =  nav_button.format(text=f'App{k:02d}', href=nav_button_href.format(k=k)) + text_Alert_this \n    l_pn_cards.append ( construct_pane_Alert (f"### {AlertHighlightTitle}\\r\\n"+text_Alert_this, l_type_Alert[k]) ) \n\ntabs_content = [ (t, l_pn_cards[i]) for i,t in define_tabs_title_short.items()]\npane_tabs = pn.Tabs( *tuple( tabs_content ), sizing_mode='stretch_width', align='center')\npane_tabs.active = _this_app_N_\n\n\n_formula_note_ = ", \\n".join([ f"\u22c6 {x}: {N_(x)}" for x in ['ContributionRatio', 'weight', 'idx'] ])\n_formula_= r"$$ContributionRatio=\\frac{\\sum_{}^{}weight}{\\sum_{}^{}idx}$$"\n\npn_formula = pn.Column ( pn.pane.LaTeX( _formula_, styles={"font-size": "18pt", "line-height": "150%"}), \n             pn.pane.Str( _formula_note_, styles={"font-size": "10pt", "line-height": "120%"}),)\n\n\n\n\n\nfrom bokeh.palettes import Category20 #Category10\ncolor_list = Category20[20]\n\nfrom bokeh.models.widgets.tables import NumberFormatter, BooleanFormatter\nbokeh_formatters = {\n    N_('weight'): NumberFormatter(format='0.00'),\n    N_('PlotRatio'): NumberFormatter(format='0.00%'),\n}\n\n\nimport holoviews as hv\nhv.extension('bokeh', inline=True)\nimport hvplot.pandas\nhv.opts.defaults(\n    hv.opts.Curve(\n        default_tools=['save', 'pan', 'wheel_zoom', 'box_zoom', 'reset'],\n        active_tools =['pan'],\n        width=150, height=120, padding=(0, (0, 0)),\n        color= pn.template.FastGridTemplate.accent_base_color,\n        xrotation=90, xformatter='%d',\n        fontsize={'title': 12, 'labels': 9, 'xticks': 8, 'yticks': 8,}\n   )\n)      #xlim=(ymin-1, ymax+1), xticks=list(range(ymin, ymax, 2)),\n\n\nfrom bokeh.palettes import Category10\ncolor_list = list ( reversed( Category10[10] ))\ncolor_cycle = hv.Cycle( np.array(color_list).tolist() )  #.repeat(2) # https://stackoverflow.com/questions/72136144/repeat-a-lists-elements-in-the-same-order\nline_dashes = hv.Cycle(["dashed", "dotted", 'dotdash']) # 'dashdot' "solid"  hv.Cycle(["dashed" if k in muted_false_default else "solid" for k in keys]) #hv.Cycle(["dotted", "solid"])  # ['-', '--', ':', '-.']\nmarkers =     hv.Cycle(['*', 'd', 'circle_x', 's', '+']) # hv.Cycle(["+" if k in muted_false_default else "d" for k in keys] )  # hv.Cycle(['*', 'd'])\nsizes =       hv.Cycle([10, 8, 9, 8, 12])    #hv.Cycle([1 if k in muted_false_default else 8 for k in keys] )     # hv.Cycle([10, 8])\n\nopts_multi = {'Curve':   {'color': color_cycle, 'line_dash': line_dashes, } , 'Scatter': {'color': color_cycle, "marker": markers, 'size': sizes},}\n\n\n\n\ndef hook_legend_reverse(plot, element):\n    plot.handles["plot"].legend[0].items.reverse()\n\n\n\nfrom panel.viewable import Viewer\npn.extension("echarts")\nimport pyecharts.options as pyec_opts\nfrom pyecharts.charts import Gauge #, Graph, Sankey\n\nclass CustomGauge (Viewer):\n    p_name  = param.Parameter() \n    p_value = param.Parameter() \n    def init_Gauge (self, name, value, fs_title=20, fs_detail=20, labelv_color = "#F08080", label_color = "auto",\n                    colors =[(0.3333, "#C70039"), (0.667, "#FFC300"), (1, "#58D9F9")], \n                    indicator_label=N_("Indicator"),formatter_js="{value}%", width=160, height=150):  ## Some accent colors that work well are \n        self.p_name = name\n        self.p_vlaue = value\n        value = round(value,2)\n        c = ( Gauge (init_opts=pyec_opts.InitOpts(width=f"{width}", height=f"{height}"))\n                 .add(indicator_label, [(name, value)], radius="86%", split_number=5, start_angle=180+15, end_angle=-15,\n                center            = ['50%', '70%'],\n                axislabel_opts    = {"distance": -30,        "rotate": 'tangential'}, \n                axistick_opts     = {"distance": -6, "length": 12, "lineStyle": {"color": 'auto',"width": 1}}, \n                pointer           = pyec_opts.GaugePointerOpts(width=3, length="85%"),\n                title_label_opts  = pyec_opts.GaugeTitleOpts (font_size=fs_title, color=labelv_color, offset_center=["0%", "-135%"]),\n                detail_label_opts = pyec_opts.GaugeDetailOpts(font_size=fs_detail, color=label_color, formatter=formatter_js, offset_center=["0%", "50%"]),\n                axisline_opts     = pyec_opts.AxisLineOpts(linestyle_opts=pyec_opts.LineStyleOpts(color=colors, width=6)),\n                     ).set_global_opts( legend_opts=pyec_opts.LegendOpts(is_show=False))      \n            )\n        return c\n    def __init__(self, p_name, p_value, width=160, height=150, **params):\n        super().__init__(**params)\n        self.Gauge = self.init_Gauge(p_name, p_value, width=width, height=height, **params)\n    def __panel__ (self):\n        return pn.pane.ECharts( self.Gauge ) \n        \n    @param.depends('p_name', 'p_value') \n    def update (self, p_name, p_value):        \n        self.Gauge.options['series'][0]['data'][0]['value'], \\\n        self.Gauge.options['series'][0]['data'][0]['name'] = \\\n        round(p_value,2), p_name\n\n\n\n\ndef plot_max_and_latest_gauge (dfrx, width=160, height=150):\n    if type ( dfrx ) is param.DataFrame:\n        d_dauge = get_max_and_latest (dfrx.rx.value)\n    else:\n        d_dauge = get_max_and_latest (dfrx)\n    GaugeA = CustomGauge(p_name=d_dauge["max"][N_('year')],    p_value=d_dauge["max"][N_("indicator")], width=width, height=height)\n    GaugeB = CustomGauge(p_name=d_dauge["latest"][N_('year')], p_value=d_dauge["latest"][N_("indicator")], width=width, height=height)\n    return GaugeA, GaugeB\n\n\n\ndef dataframe_grp_sum_sorted (df, grpby=[N_('t_org02'),N_('year')], pagg={N_('weight'):'sum', N_('idx'):'nunique'}, ps_v= dict(by=N_('weight'), ascending=False),):\n    return df.groupby(grpby).agg(pagg).sort_values(**ps_v).reset_index()\ndef get_stats_org02 (df_cw, TopN=15):\n    if TopN is None: return dataframe_grp_sum_sorted (df_cw, grpby=[N_('t_org02')])\n    else: return dataframe_grp_sum_sorted (df_cw, grpby=[N_('t_org02')]).head(TopN)\ndef get_stats_org02_years  (df_cw, TopN=None):\n    if TopN is None: return dataframe_grp_sum_sorted (df_cw)\n    else: return dataframe_grp_sum_sorted (df_cw).head(TopN)\ndef get_stats_org02_source  (df_cw, TopN=None):\n    if TopN is None: return dataframe_grp_sum_sorted (df_cw, grpby=[N_('source')])\n    else: return dataframe_grp_sum_sorted (df_cw, grpby=[N_('source')]).head(TopN)\n        \ndef get_max_and_latest(dfr, col_y=N_('year'), col_t=N_('ratio_c'), label_indicator=N_('indicator')):\n    ser = dfr[[col_y, col_t]].set_index(col_y)\n    year_max, year_latest = ser.idxmax()[col_t], ser.index.max()\n    indicator_max, indicator_latest = ser.max()[col_t], ser.loc[year_latest][col_t]\n    return {"max":   {col_y:   int(year_max), label_indicator:  float( 100*round(indicator_max,    4) ) },\n            "latest":{col_y:int(year_latest), label_indicator:  float( 100*round(indicator_latest, 4) ) },}\ndef get_rolling_window (df, _win_, col_weight=N_('weight'), col_idx=N_('idx'), on_col=N_('year'), min_periods=1,\n                        col_n1=N_('ratio_c'), col_n2=N_('rolling_weight'), col_n3=N_('rolling_idx'), col_n4=N_('rolling_ratio')):\n    ds = df.assign(**{col_n1: df[col_weight]/df[col_idx].astype(np.float16)})\n    ds = ds.assign(**{col_n2: ds.rolling(window=_win_, on=on_col, min_periods=min_periods).mean()[col_weight] })\n    ds = ds.assign(**{col_n3: ds.rolling(window=_win_, on=on_col, min_periods=min_periods).mean()[col_idx] } )\n    ds = ds.assign(**{col_n4: ds[col_n2]/ds[col_n3] })\n    ds = ds.sort_values(by=on_col, ascending=False)\n    return ds\n\n\n\nfrom bokeh.models.widgets.tables import NumberFormatter\nbokeh_formatters = {\n    N_('weight'): NumberFormatter(format='0.00'),\n}\n\nwidth_tab_default=350\ndef stats_style_format(df, w_vmax=60, i_vmax=120, debug=True):  ##### styled_df dfs\n    dfs = df.style.format('{:.2f}', na_rep="", subset=[N_('idx'), N_('weight')]).set_properties(**{ 'format': '{:.2f}', 'color': 'yellow', 'font-weight': 'bold', 'text-shadow': '1px 1px 7px #000, -1px -1px 7px #000, 1px -1px 2px #000, 1px -1px 2px #000;'}, subset=[N_('weight'),N_('idx')])\\\n      .bar(align="left", vmin=0, vmax=w_vmax, cmap="Reds", height=75, width=80, props="width: 100px; border-right: 1px solid black;", subset=[N_('weight')])\\\n      .bar(align="left", vmin=0, vmax=i_vmax, cmap="Blues", height=75, width=80, props="width: 100px; border-right: 1px solid black;", subset=[N_('idx')])\n    return dfs\n\ndef tab_stats_default (sdf, editors={}, text_align="left", show_index=False, pagination='local', page_size=10, width=width_tab_default, widths= {}, **kwargs):\n    return pn.widgets.Tabulator ( sdf, editors=editors, text_align=text_align, show_index=show_index, pagination=pagination, page_size=page_size, width=width, formatters=bokeh_formatters, **kwargs)\n    \ndef tab_w_style_auto_max (func, df_cw, sorters=[{'field': N_('weight'), 'dir': 'desc'}], col_vars = [N_('weight'),N_('idx')], width=width_tab_default, widths={}, **kwargs):   #####  **kwargs to stats_style_format\n    stats = func (df_cw)\n    col_vars_max = stats[col_vars].max().to_dict()  \n    return tab_stats_default ( stats_style_format (stats, w_vmax=col_vars_max[col_vars[0]], i_vmax=col_vars_max[col_vars[1]], **kwargs), width=width, widths=widths)\n\n\n\n_objects_[N_('col_range_year')]['opts'], _objects_[N_('col_range_year')]['default']\n\n\nfrom panel.template import DarkTheme, DefaultTheme\npn.config.theme = 'default'\nfrom panel.viewable import Viewer\npn.extension (sizing_mode="stretch_width")               # FastGrid \npn.extension( defer_load=False, loading_indicator=False) # , loading_indicator=True\nfrom io import StringIO      # For "saving" button function\nimport copy\n\n\nclass GUI (Viewer): # panel.viewable class  --> param.parameterized.ParameterizedMetaclass\n    status_interact = param.Boolean(default=True)\n    dashboard_trigger = param.Number(1)\n\n    sel_window_year= param.Integer  ( 3, bounds= (1,10), softbounds=(2,5) )  ##### App00\n    sel_org02      = param.Selector ( objects = _objects_[N_('t_org02')]['opts'], default=_objects_[N_('t_org02')]['default'] )\n    sel_range_year = param.Range    ( bounds  = _objects_[N_('col_range_year')]['opts'], default = _objects_[N_('col_range_year')]['default'],  step=1)\n    sel_method     = param.Selector ( objects = _objects_[N_('method')]['opts'],  default=_objects_[N_('method')]['default']     )\n    sel_db         = param.Selector ( objects = _objects_[N_('db')]['opts'],      default=_objects_[N_('db')]['default']    )\n    sel_Dtype_det  = param.ListSelector ( objects = _objects_[N_('Dtype_detail')]['opts'],      default=_objects_[N_('Dtype_detail')]['default']    )\n    \n    filter_tab    = param.Parameter()\n    stats_rolling = param.DataFrame()       ##### pn.bind: self.bdgauge\n    stats_org02_years = param.Parameter()\n    \n    \n    def __init__(self, dfl, use_template, **params):   # dfl <=== Multilingual DataFrameLocale object\n        """ Initiate Non-External Objects """\n        self.dfl = dfl\n        self.use_template=use_template\n        super().__init__(**params)\n        self.df    = self.dfl.df_out\n        self.df_en = self.dfl.df\n        \n        cols_shown = [N_('method'),N_('db'),N_('Dtype_detail'),N_('year'),N_('weight'),N_('idx'),N_('t_Author'),N_('t_org02'),N_('source')]   ## Data field selection and pre-ordering\n        self.df = self.df[cols_shown].sort_values(by=[N_('year'), N_('Dtype_detail'), N_('method')], ascending=[False,True,True])\n        self.w_sel_org02  = pn.widgets.Select.from_param(self.param.sel_org02, name=N_('SelectOrg02'), value = None, sizing_mode='stretch_width')         \n        self.w_window_year= pn.widgets.IntSlider.from_param(self.param.sel_window_year, name=N_('SelectTimeWindowSize'), width=320)         \n        self.w_range_year = pn.widgets.IntRangeSlider.from_param(self.param.sel_range_year, name=N_('SelectYearRange'), sizing_mode='stretch_width')         \n        self.w_method     = pn.widgets.RadioButtonGroup.from_param(self.param.sel_method, button_type ='success', button_style ='outline', sizing_mode='stretch_width')\n        self.w_db         = pn.widgets.RadioButtonGroup.from_param(self.param.sel_db, button_type ='warning', value = None, button_style ='outline', sizing_mode='stretch_width')  ### value meaning  EI|WoS\n        self.w_Dtype_det  = pn.widgets.CheckBoxGroup.from_param(self.param.sel_Dtype_det,  name=N_('SelectDtypeScope'), inline=True)\n        self.w_save    = pn.widgets.FileDownload( name='', label=N_('ButtonSave'), embed=False, button_type ='primary', align=('center', 'end'), width=75,\n                                                  callback=pn.bind(self.save_current_view), filename=N_('ButtonSave')+".csv") \n        self.w_refresh = pn.widgets.Button(name=N_('ButtonRefresh'), button_type ='warning', align=('start', 'end'), width=85)  # 360-180 = 180, 180/2=80\n        self.w_refresh.on_click(self.update_current_view_wider)\n        self.w_refresh.on_click(self.update_current_view)\n\n        self.init_tabulators()       # \u23ec TAB: self.filter_tab self.filter_tab_wider self.filter_tab_narrower\n        self.get_rolling_external()                    # <-------------------- \U0001f387  data (init) and update once \n        self.get_stats_external()                      # <-------------------- \U0001f387  data (init) and update once   self.l_org02\n\n        self.bdgauge = pn.bind ( get_max_and_latest, self.param.stats_rolling)\n        self.init_gauges ()\n        self.TopN_mainplot = 12\n        self.bplt_stats_plot_org02 = pn.bind (self.stats_plot_org02, _df_=self.param.stats_org02_years, keys = self.l_org02[0:self.TopN_mainplot])   ##### only Top10\n        self.bplt_stats_rolling = pn.bind (self.data_plot, _df_=self.param.stats_rolling, y_bar = N_('rolling_weight'), y_line = N_('rolling_idx') , line_dash = 'dashed', colors = color_list[0:] , border=0  )\n        self.bplt_stats_originl = pn.bind (self.data_plot, _df_=self.param.stats_rolling, y_bar = N_('weight'), y_line = N_('idx'), line_dash = 'dotdash', colors = color_list[6:] , border=0)\n        self.bplt_stats_ratio = pn.bind (self.data_plot, _df_=self.param.stats_rolling, y_bar = N_('ratio_c'), y_line = N_('rolling_ratio'), line_dash = 'solid', line_dash_hline='solid', colors = color_list[4:], colors_hline = ('red','blue'),\n                                         label_stats = N_('threshold'), hline_marks = {N_('ratio_c'): 0.3333,  N_('rolling_ratio'): 0.6667}, border=0 ) # , width=320, height=360        \n\n        self.pane_tabs = pane_tabs \n        self.init_widgetbox()\n        \n    def update_tab_df_attempt(self, _obj_, df):\n        try: _obj_.value = df\n        except Exception as e: print (e)\n    def get_stats_external (self):\n        self.df_wider    = self.filter_tab_wider.current_view\n        self.stats_org02 = get_stats_org02 (self.df_wider)  ##### self.\n        self.l_org02 = self.stats_org02[N_('t_org02')].tolist() \n        """##### \U0001f69b category: stats over the years"""\n        self.stats_org02_years = get_stats_org02_years (self.df_wider).sort_values(by=[N_('t_org02'), N_('year')])\n        self.update_tab_df_attempt (self.tab_stats_org02,        get_stats_org02 (self.filter_tab.current_view) )\n        self.update_tab_df_attempt (self.tab_stats_org02_source, get_stats_org02_source (self.filter_tab.current_view) )\n        \n    def get_rolling_external (self):   ##### Similar to get_stats_external\n        """ \U0001f69a  ydf  + \U0001f69b rolling: stats over the years """\n        self.ydf = self.filter_tab.current_view[[N_('year'),N_('weight'), N_('idx')]].reset_index(drop=True).groupby(by=N_('year')).agg({N_('weight'):"sum", N_('idx'):"nunique"}).reset_index()\n        self.stats_rolling = get_rolling_window (self.ydf, self.sel_window_year) \n        \n    width_plot_default = 275\n    height_plot_default = 275\n    legend_offset = (0, +25)\n    def data_plot (self, _df_, y_bar = N_('weight'), y_line = N_('idx'), label_stats = N_('mean'), hline_marks=None,\n                        colors = color_list, colors_hline = None, line_dash='dashed', line_dash_hline='dotted', legend_position='top', \n                        legend_offset= legend_offset,\n                        width=width_plot_default, height=height_plot_default, *args, **kwargs):        \n        if colors_hline is None: colors_hline = (colors[1], colors[3])\n        if hline_marks is None:     #  Use mean for hline_marks if not supplied\n            stats_mean = _df_[[y_bar,y_line]].mean().to_dict()  # annual average {'rolling_weight': 143.0853174603175, 'rolling_idx': 186.64285714285714}\n        else:\n            stats_mean = hline_marks\n        try:\n            y_bar_minmax = _df_[y_bar].min(), _df_[y_bar].max()\n            y_line_minmax = _df_[y_line].min(), _df_[y_line].max()\n            x_minmax = _df_[N_('year')].min()-1, _df_[N_('year')].max() + 1\n            y_minmax = 0, _df_[y_line].max() *1.1\n            \n            plt_bar  = _df_.hvplot(label=y_bar, kind='bar', x=N_('year'), y=y_bar).opts(active_tools=['pan'], color=colors[0], line_dash=line_dash, line_width=1, bar_width=0.75, shared_axes=False, )\n            plt_line = _df_.hvplot(label=y_line, kind='line', x=N_('year'), y=y_line).opts( active_tools=['pan'], color=colors[2], line_dash=line_dash, line_width=2)\n            hline_bar_mean = hv.Curve([[x_minmax[0], stats_mean[y_bar]], [x_minmax[1], stats_mean[y_bar]]], label=': '.join(['', label_stats + f"={stats_mean[y_bar]:.2f}"]) ).opts(color=colors_hline[0], line_dash=line_dash_hline, line_width=3) \n            hline_line_mean = hv.Curve([[x_minmax[0], stats_mean[y_line]], [x_minmax[1], stats_mean[y_line]]], label=': '.join(['', label_stats + f"={stats_mean[y_line]:.2f}"]) ).opts(color=colors_hline[1], line_dash=line_dash_hline, line_width=3)\n            plot_Trend = (hline_bar_mean * hline_line_mean *  plt_bar * plt_line ).opts(hooks=[hook_legend_reverse], legend_offset=legend_offset, shared_axes=False, xlabel=N_('year'), ylabel='', xlim=x_minmax, ylim=y_minmax, \n                                                                                        legend_position=legend_position,legend_cols=2, width=width, height=height, *args, **kwargs)\n            return plot_Trend.opts(xlim=(self.sel_range_year[0]-1, self.sel_range_year[1]+1) ) # App02.param.sel_range_year.rx()\n        except Exception as e:\n            print (f">>> plot subfunction > {e}: {kwargs} ")\n    width_plot_wide_default = 480\n    legend_offset = (0, -55)\n    def stats_plot_org02 ( self, _df_, keys = None, y_picked = N_('weight'), xlim=(2015,2025), height=height_plot_default, width=width_plot_wide_default, \n                           legend_position='left', legend_offset=legend_offset,  options = opts_multi, **kwargs ):    \n        if keys == None:\n            keys = self.l_org02[12]\n        objLineExp    = hv.Overlay(  [_df_.query(f"{N_('t_org02')} == @key").hvplot(x=N_('year'), y=y_picked, label = key, kind="line")\\\n                                          .opts(muted = False if key in muted_false_default else True) for key in keys ]                          )\n        objScatterExp = hv.Overlay(  [_df_.query(f"{N_('t_org02')} == @key").hvplot(x=N_('year'), y=y_picked, label = key, kind="scatter", \n                                               hover_cols=[N_('year'), N_('t_org02'), y_picked])\\\n                                          .opts(muted = False if key in muted_false_default else True) for key in keys ]                          )\n        NdOvl = ( objLineExp * objScatterExp ).opts( xlim=xlim, xlabel=N_('year'), ylabel='', shared_axes=False, legend_position=legend_position, legend_offset=legend_offset, height=height, width=width, background_fill_color=None, **kwargs)  #  hooks=[hook_legend_reverse],      title = Figlabel,       yformatter = UFormatter_indicator,                 ylabel = FigYlabel, xlabel = FigXlabel,        legend_cols=1)\n        return NdOvl.options(options)\n\n    @pn.depends ('status_interact', watch=True)\n    def disable_sidebar_wb(self):\n        self.pn_sidebar_wb.disabled = not self.status_interact\n\n    \n    @pn.depends ('sel_method', 'sel_db', 'sel_Dtype_det', watch=True) # \n    def update_current_view_wider (self, event=None):       # event=None clickable\n        self.filter_tab_wider._update_cds()                              ##### Wait for the tabulator content updated\n        self.get_stats_external()                      # <-------------------- \U0001f387  data (init) and update once \n\n    \n    @pn.depends ('sel_org02','sel_window_year','sel_range_year','sel_method', 'sel_db', 'sel_Dtype_det', watch=True) # \n    def update_current_view (self, event=None): # event=None clickable\n        self.filter_tab._update_cds()                              ##### Wait for the tabulator content updated\n        try:\n            self.status_interact, self.main1.loading = False, True\n            self.get_rolling_external()                    # <-------------------- \U0001f387  data (init) and update once \n            self.get_stats_external()                      # <-------------------- \U0001f387  data (init) and update once \n            self.update_gauges(self.bdgauge())             # <-------------------- \U0001f9e8  data (init) and update once\n            self.dashboard_trigger = self.dashboard_trigger + 1\n        except Exception as e:   print (f">>> {e}")\n        finally:                 self.status_interact, self.main1.loading = True, False\n       \n    def init_widgetbox (self):\n        self.pn_Method_db  = pn.Column ( pn.widgets.StaticText(name=N_('SelectMethodDBScope'), value=N_('SelectMethodDBScopeBrief')), self.w_db, self.w_method, \n                                         pn.widgets.StaticText (name=N_('Footnote'), value=N_('SelectMethodDBScopeNote')) )\n        self.pn_Dtype = pn.Column ( pn.widgets.StaticText(name=N_('SelectDtypeScope'), value=N_('SelectDtypeScopeBrief')), self.w_Dtype_det)        \n        self.pn_sidebar_wb = pn.WidgetBox (self.w_sel_org02, pn.layout.Divider(), self.w_window_year,  self.w_range_year, pn.layout.Divider(), \n                                           self.pn_Method_db, pn.layout.Divider(), pn.Row(self.pn_Dtype), pn.layout.Divider(), pn.Row(self.w_save, self.w_refresh))\n\n    def init_tabulators (self):             \n        """Tabulator self.filter_tab: Main Contributing Authors and Organzations"""\n        self.filter_tab          = pn.widgets.Tabulator(self.df, show_index=False, pagination='local', page_size=10)\n        self.filter_tab.add_filter(self.param.sel_method,   N_('method') )                  # add dynamic filter\n        self.filter_tab.add_filter(self.param.sel_db,       N_('db') )                      # add dynamic filter\n        self.filter_tab.add_filter(self.param.sel_Dtype_det,N_('Dtype_detail')  )           # add dynamic filter\n        self.filter_tab.add_filter(self.param.sel_org02,    N_('t_org02') )                 # \u2795 add_filter org02 add dynamic filter\n        """Tabulator stats_org02: Main Contributing Organzations org02"""\n        self.tab_stats_org02        = tab_w_style_auto_max (get_stats_org02, self.filter_tab.current_view)\n        """Tabulator stats_org02_source"""\n        self.tab_stats_org02_source = tab_w_style_auto_max (get_stats_org02_source, self.filter_tab.current_view, width=420, widths= {N_('source'):"45%"} )  ## wider\n        \n        self.filter_tab_wider    = pn.widgets.Tabulator(self.df, show_index=False, pagination='local', page_size=10)\n        self.filter_tab_wider.add_filter(self.param.sel_method,   N_('method') )    # add dynamic filter\n        self.filter_tab_wider.add_filter(self.param.sel_db,       N_('db') )        # add dynamic filter\n        self.filter_tab_wider.add_filter(self.param.sel_Dtype_det,N_('Dtype_detail')  )        # add dynamic filter\n\n        \n    def init_gauges (self):             \n        d_dauge = self.bdgauge()  # using  pn.bind ( get_max_and_latest, self.param.stats_rolling)\n        self.GaugeA = CustomGauge(p_name=d_dauge["max"][N_('year')],    p_value=d_dauge["max"][N_("indicator")])\n        self.GaugeB = CustomGauge(p_name=d_dauge["latest"][N_('year')], p_value=d_dauge["latest"][N_("indicator")])\n        self.pane_gauges = pn.Row ( self.GaugeA, self.GaugeB )  # initiate\n    def update_gauges (self, d_dauge):\n        self.GaugeA.update(p_name=d_dauge["max"][N_('year')],    p_value=d_dauge["max"][N_("indicator")])\n        self.GaugeB.update(p_name=d_dauge["latest"][N_('year')], p_value=d_dauge["latest"][N_("indicator")]) \n        self.pane_gauges = pn.Row ( self.GaugeA, self.GaugeB )  \n    def get_pane_debug (self):  # get_records_N here\n        return pn.pane.Markdown(f"* N = {self.filter_tab.current_view.shape[0]}\\n* N (idx) = {self.filter_tab.current_view[N_('idx')].nunique()}\\n  ")\n    def save_current_view (self, event=None): # event=None clickable\n        self.df_this =  self.filter_tab.current_view        \n        sio = StringIO()\n        self.df_this.to_csv(sio, encoding='utf8')\n        sio.seek(0)\n        return sio\n    def get_pane_gauges (self):              # for __panel__\n        return self.pane_gauges\n    \n    def __panel__(self):\n        """ Panel composition, layout and status """    \n        self.pn_sidebar = pn.Column ( pn.Card( self.pane_tabs, title=N_('Menu'), styles=pn_card_custom_style_i ), \n                                      pn.Card( self.pn_sidebar_wb, title=N_('WidgetBox'), styles=pn_card_custom_style_w ),       \n                                      pn.Card( self.get_pane_debug, title=N_('PaneDebug'), styles=pn_card_custom_style_s ),                width=360 ) # width=370 # \u267b\ufe0f--> (App02) # self.pane_Ref, \n\n        main0_title = N_('TrendPlotTitle').format(N_('t_org02'),self.TopN_mainplot,N_('weight'))\n        self.main0 = pn.Row ( pn.Column ( pn.Row(f"## {main0_title}", align="center", sizing_mode="fixed", width=480), self.bplt_stats_plot_org02, N_('TrendPlotNote'), align=('center'), sizing_mode="stretch_both"),     width=880 )\n        self.main1 = pn.Column ( f"## {N_('Stats_Sel')}", pn.Row ( \n                         pn.Column (self.tab_stats_org02, sizing_mode="stretch_both"), pn.Column ( self.tab_stats_org02_source, sizing_mode="stretch_both") ),     width=880 )\n        self.main2 = pn.Row ( pn.Column ( f"### {N_('PlotRollingTitle')}", self.bplt_stats_rolling, sizing_mode="stretch_both"), \n                              pn.Column ( f"### {N_('PlotYearlyTitle')}", self.bplt_stats_originl, sizing_mode="stretch_both" ),     width=880 )\n        self.main3 = pn.Row ( pn.Column ( f"### {N_('GaugeTitle')}", self.get_pane_gauges, f"### {N_('ContributionRatioFormula')}", pn_formula, sizing_mode="stretch_both"), \n                              pn.Column ( f"### {N_('PlotRatio')}", self.bplt_stats_ratio, sizing_mode="stretch_both" ), width=880 )\n        self.main4 = pn.Column ( f"## {N_('Data_Filtered')}",   pn.Row ( self.filter_tab ) ,         width=880 ) \n        \n        if self.use_template:\n            PNtemplate = pn.template.FastGridTemplate(theme= DefaultTheme,  sidebar = self.pn_sidebar, prevent_collision=True, **template_param) # theme= DefaultTheme  DarkTheme\n            PNtemplate.main [  :4, : ]  = self.main0\n            PNtemplate.main [ 4:8, : ]  = self.main1\n            PNtemplate.main [ 8:12, : ] = self.main2\n            PNtemplate.main [12:16, : ] = self.main3\n            PNtemplate.main [16:20, : ] = self.main4\n            return PNtemplate\n        else:\n            return pn.Row (self.pn_sidebar, pn.Column( self.main0, self.main1, self.main2, self.main3, self.main4) )\n\nApp01_servable = GUI ( dfl, use_template=True )  # <-----------------------  Using locale \n\n\n\nApp01_servable.servable()  ### \U0001f6a8 Service Browser External\n\n\nawait write_doc()
  `

  try {
    const [docs_json, render_items, root_ids] = await self.pyodide.runPythonAsync(code)
    self.postMessage({
      type: 'render',
      docs_json: docs_json,
      render_items: render_items,
      root_ids: root_ids
    })
  } catch(e) {
    const traceback = `${e}`
    const tblines = traceback.split('\n')
    self.postMessage({
      type: 'status',
      msg: tblines[tblines.length-2]
    });
    throw e
  }
}

self.onmessage = async (event) => {
  const msg = event.data
  if (msg.type === 'rendered') {
    self.pyodide.runPythonAsync(`
    from panel.io.state import state
    from panel.io.pyodide import _link_docs_worker

    _link_docs_worker(state.curdoc, sendPatch, setter='js')
    `)
  } else if (msg.type === 'patch') {
    self.pyodide.globals.set('patch', msg.patch)
    self.pyodide.runPythonAsync(`
    from panel.io.pyodide import _convert_json_patch
    state.curdoc.apply_json_patch(_convert_json_patch(patch), setter='js')
    `)
    self.postMessage({type: 'idle'})
  } else if (msg.type === 'location') {
    self.pyodide.globals.set('location', msg.location)
    self.pyodide.runPythonAsync(`
    import json
    from panel.io.state import state
    from panel.util import edit_readonly
    if state.location:
        loc_data = json.loads(location)
        with edit_readonly(state.location):
            state.location.param.update({
                k: v for k, v in loc_data.items() if k in state.location.param
            })
    `)
  }
}

startApplication()